# Environment Configuration Guide

This project uses a two-file approach for environment configuration:

## File Separation

### `.env` (gitignored)
**Purpose**: Secrets and generated instance-specific values

**Contents**:
- API keys and passwords
- Generated port allocations (by setup-agent.sh)
- Instance-specific identifiers (agent names, etc.)

**Example**:
```bash
# Secrets (add manually)
ANTHROPIC_API_KEY=sk-ant-xxx
DATABASE_PASSWORD=secret123

# Generated by setup-agent.sh
AGENT_NAME=fix-auth-bug
MAIN_PORT=3010
API_PORT=3011
DEBUG_PORT=3012
```

### `.envrc` (committed)
**Purpose**: Non-secret tool configuration and developer customizations

**Contents**:
- Tool configuration (STARSHIP_CONFIG, etc.)
- PATH modifications
- Shell functions
- Feature flags
- Development settings

**Location**: 
- Main repository has one at root
- Each worktree gets a copy when created
- Can be customized per worktree if needed

**Example**:
```bash
# Load secrets and generated values
if [ -f .env ]; then
    set -a; source .env; set +a
fi

# Tool configuration
export STARSHIP_CONFIG="$PWD/.config/starship.toml"
export LOG_LEVEL=${LOG_LEVEL:-info}

# Add scripts to PATH
PATH_add scripts

# Shell functions
check-services() {
    if [ -x "scripts/check-services.sh" ]; then
        scripts/check-services.sh "$@"
    fi
}
export -f check-services
```

## How It Works

1. **direnv** automatically loads `.envrc` when you enter a directory
2. `.envrc` sources `.env` to get secrets and generated values
3. Both sets of variables are available in your shell
4. Starship uses `STARSHIP_CONFIG` to find worktree-specific prompt

## For Developers

### Adding a new secret
Add to `.env` (never commit this):
```bash
echo "MY_SECRET=value" >> .env
```

### Adding a new configuration
Add to `.envrc` (this is committed):
```bash
echo 'export MY_CONFIG=value' >> .envrc
direnv reload
```

### Per-developer overrides
Create `.env.local` for personal secrets/overrides:
```bash
# .env.local (gitignored)
ANTHROPIC_API_KEY=my-personal-key
LOG_LEVEL=trace  # Override for debugging
```

## Security Notes

1. **Never commit .env files** - They may contain secrets
2. **Review .envrc before committing** - Ensure no secrets
3. **Use direnv allow** - direnv requires explicit permission per directory
4. **Audit regularly** - Check that secrets aren't in .envrc

## Common Patterns

### Feature flags in .envrc
```bash
# .envrc
export FEATURE_NEW_UI=true
export DEBUG_MODE=${DEBUG_MODE:-false}  # Can override via .env
```

### Dynamic configuration
```bash
# .envrc
export BUILD_PATH="$PWD/build"
export CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/myproject"
```

### Conditional configuration
```bash
# .envrc
if [[ -f "docker-compose.yml" ]]; then
    export DOCKER_COMPOSE_FILE="$PWD/docker-compose.yml"
fi
```

## Troubleshooting

**direnv not loading**:
```bash
direnv allow .  # Grant permission
direnv reload   # Force reload
```

**Can't find secret**:
```bash
# Check both files
grep MY_VAR .env .envrc
```

**Starship not using custom config**:
```bash
echo $STARSHIP_CONFIG  # Should point to scripts/starship.toml
```